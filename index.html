<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é›ªçµæ™¶ æˆé•·ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆä¸­è°·ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ é¢¨ / æ¡ä»¶åˆ‡æ›¿ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼‰</title>
<style>
  :root{
    --bg:#0b1020; --panel:#111a33cc; --ink:#e9eeff; --muted:#aab4dd;
    --btn:#1e2b59; --btn2:#27387a; --accent:#7dd3fc;
    --line:#2a3a7a55;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:radial-gradient(1000px 600px at 30% 10%, #182b66 0%, var(--bg) 60%);
    color:var(--ink);
    font-family:system-ui,-apple-system,"M PLUS Rounded 1c",sans-serif;
  }
  header{
    position:sticky;top:0;z-index:5;
    background:linear-gradient(#0b1020ee,#0b102000);
    padding:12px 14px 10px;
    backdrop-filter: blur(6px);
  }
  h1{margin:0;font-size:16px;font-weight:800;letter-spacing:.02em}
  .wrap{display:grid;grid-template-columns: 1fr; gap:10px; padding:10px 12px 16px; max-width:1200px; margin:0 auto;}
  @media (min-width: 980px){ .wrap{grid-template-columns: 1fr 420px;} }
  .card{background:var(--panel); border:1px solid var(--line); border-radius:14px; overflow:hidden;}
  .stage{padding:10px;}
  canvas{width:100%;height:auto;display:block;border-radius:12px;background:#070b16; border:1px solid var(--line);}
  .side{padding:12px 12px 10px; display:flex; flex-direction:column; gap:10px;}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  .btn{
    border:0; padding:10px 12px; border-radius:12px; color:var(--ink);
    background:linear-gradient(180deg,var(--btn2),var(--btn));
    cursor:pointer; font-weight:800; letter-spacing:.02em;
  }
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:#0000;border:1px solid #2a3a7a88}
  .btn.small{padding:7px 10px;font-size:12px;border-radius:10px}
  label{font-size:12px;color:var(--muted)}
  input[type="range"]{width:100%}
  input[type="number"]{width:92px; padding:7px 8px; border-radius:10px; border:1px solid #2a3a7a88; background:#0a1230; color:var(--ink);}
  select{padding:7px 8px; border-radius:10px; border:1px solid #2a3a7a88; background:#0a1230; color:var(--ink);}
  .kv{display:grid; grid-template-columns: 1fr auto; gap:6px 10px; font-size:12px; color:var(--muted)}
  .kv b{color:var(--ink); font-weight:800}
  .note{font-size:12px;color:var(--muted); line-height:1.5}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0f1a3e;border:1px solid #2a3a7a66;font-size:12px;color:var(--muted)}
  .warn{color:#ffd88a}
  .ok{color:#9ff0c5}
  .table{
    width:100%;
    border-collapse: collapse;
    font-size:12px;
    color:var(--muted);
    overflow:hidden;
    border-radius:12px;
  }
  .table th,.table td{
    border-bottom:1px solid #2a3a7a44;
    padding:8px 6px;
    vertical-align:middle;
  }
  .table th{color:var(--ink); text-align:left; font-weight:800;}
  .table td b{color:var(--ink)}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3a7a88;background:#0a1230;color:var(--muted);font-size:11px}
  .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
</style>
</head>
<body>
<header>
  <h1>â„ï¸ é›ªçµæ™¶ æˆé•·ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆä¸­è°·ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ é¢¨ + é€”ä¸­ã§æ¸©åº¦/æ¹¿åº¦ã‚’åˆ‡æ›¿ï¼‰</h1>
</header>

<div class="wrap">
  <div class="card stage">
    <canvas id="cv" width="900" height="900" aria-label="snowflake canvas"></canvas>
  </div>

  <div class="card side">
    <div class="row">
      <button id="btnStart" class="btn">â–¶ é–‹å§‹</button>
      <button id="btnStep" class="btn ghost">ï¼‹1ã‚¹ãƒ†ãƒƒãƒ—</button>
      <button id="btnReset" class="btn ghost">â†º ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="btnSnap" class="btn ghost">ğŸ“· PNGä¿å­˜</button>
    </div>

    <div class="row">
      <span class="pill">ç¾åœ¨ã®æ¡ä»¶</span>
      <span class="tag">æ¸©åº¦ <b id="tempLabel">âˆ’15â„ƒ</b></span>
      <span class="tag">æ¹¿åº¦ <b id="supLabel">é«˜</b></span>
      <span class="tag">ãƒ¢ãƒ¼ãƒ‰ <b id="modeLabel">æ¨¹æçŠ¶</b></span>
    </div>

    <div>
      <label>æ¸©åº¦ï¼ˆæ‰‹å‹•ï¼‰</label>
      <input id="temp" type="range" min="-35" max="-2" step="1" value="-15">
    </div>

    <div>
      <label>æ¹¿åº¦/éé£½å’Œåº¦ï¼ˆæ‰‹å‹•ï¼‰</label>
      <input id="sup" type="range" min="0" max="100" step="1" value="85">
    </div>

    <div class="row">
      <label style="display:flex;gap:8px;align-items:center">
        <input id="symLock" type="checkbox">
        6å›å¯¾ç§°ãƒ­ãƒƒã‚¯ï¼ˆONã«ã™ã‚‹ã¨å…­è§’å½¢ã«å¯„ã‚ŠãŒã¡ï¼‰
      </label>
      <label style="display:flex;gap:8px;align-items:center">
        <input id="showVapor" type="checkbox">
        æ°´è’¸æ°—ï¼ˆèƒŒæ™¯ï¼‰ã‚’è¡¨ç¤º
      </label>
    </div>

    <div class="kv">
      <div>ã‚¹ãƒ†ãƒƒãƒ—</div><b id="steps">0</b>
      <div>æ°·ã‚»ãƒ«æ•°</div><b id="iceCount">0</b>
      <div>å†…éƒ¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</div><b id="params" class="mono">â€”</b>
    </div>

    <div class="row">
      <span class="pill">ä¸­è°·ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ é¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆ</span>
      <button class="btn ghost small" data-nakaya="plate">æ¿çŠ¶ï¼ˆâˆ’2/âˆ’10/âˆ’30å¸¯ï¼‰</button>
      <button class="btn ghost small" data-nakaya="column">æŸ±çŠ¶ï¼ˆâˆ’5/âˆ’20å¸¯ï¼‰</button>
      <button class="btn ghost small" data-nakaya="dendrite">æ¨¹æçŠ¶ï¼ˆâˆ’15å¸¯ï¼‰</button>
    </div>

    <div class="row">
      <span class="pill">æ¡ä»¶åˆ‡æ›¿ãƒ—ãƒ­ã‚°ãƒ©ãƒ </span>
      <label style="display:flex;gap:8px;align-items:center">
        <input id="useProgram" type="checkbox" checked>
        ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½¿ç”¨ï¼ˆONã§é€”ä¸­åˆ‡æ›¿ï¼‰
      </label>
    </div>

    <div class="row">
      <button id="btnAddStage" class="btn ghost small">ï¼‹ã‚¹ãƒ†ãƒ¼ã‚¸è¿½åŠ </button>
      <button id="btnClearStages" class="btn ghost small">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
      <button id="btnFan" class="btn ghost small">ğŸª­ æ‰‡å…­èŠ±ãƒ¢ãƒ¼ãƒ‰</button>
      <button id="btnNakayaTour" class="btn ghost small">ğŸ—º æ¸©åº¦å¸¯ãƒ„ã‚¢ãƒ¼</button>
    </div>

    <div class="note">
      <b class="ok">æ‰‡å…­èŠ±ã«ã¤ã„ã¦ï¼š</b><br>
      é€”ä¸­ã§æ¸©åº¦ãƒ»æ¹¿åº¦ï¼ˆéé£½å’Œåº¦ï¼‰ãŒå¤‰ã‚ã‚‹ã¨ã€<br>
      <span class="warn">ã€ŒæãŒå‡ºã‚‹â†’æ¿(ã‚»ã‚¯ã‚¿ãƒ¼)ãŒå¤ªã‚‹â†’ã¾ãŸæã€</span>ã®ã‚ˆã†ã«æˆé•·æ§˜å¼ãŒåˆ‡æ›¿ã‚ã‚Šã€æ‰‡å½¢ã®â€œæ‰‡å…­èŠ±â€ã£ã½ã„å½¢ãŒå‡ºã¾ã™ã€‚<br>
      ä¸‹ã®ã‚¹ãƒ†ãƒ¼ã‚¸åˆ—ã‚’ä½¿ã†ã¨ã€æˆé•·ä¸­ã«è‡ªå‹•ã§æ¡ä»¶ãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚
    </div>

    <div style="border:1px solid #2a3a7a44;border-radius:12px;overflow:hidden">
      <table class="table" id="stageTable">
        <thead>
          <tr>
            <th>#</th>
            <th>ç¶™ç¶š(steps)</th>
            <th>æ¸©åº¦(â„ƒ)</th>
            <th>æ¹¿åº¦(0-100)</th>
            <th>ç‹™ã„</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="stageBody"></tbody>
      </table>
    </div>

    <div class="note">
      <b>ã‚³ãƒ„ï¼š</b>ã¾ãš <span class="warn">6å›å¯¾ç§°ãƒ­ãƒƒã‚¯OFF</span> ã§è©¦ã—ã¦ãã ã•ã„ã€‚<br>
      ãã‚Œã§ã‚‚å·¦å³ãŒæƒã„ã™ãã‚‹å ´åˆã¯ã€æ¹¿åº¦ã‚’ä¸Šã’ã‚‹ï¼ˆåˆ†å²å¢—ï¼‰/ä¸‹ã’ã‚‹ï¼ˆå¤ªã‚Šå¢—ï¼‰ã‚’åˆ‡æ›¿ã§ä½œã‚Œã¾ã™ã€‚
    </div>
  </div>
</div>

<script>
/* ============
  ä¸­è°·ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ é¢¨ + æ¡ä»¶åˆ‡æ›¿ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
  - å½¢ãŒã€Œæ¸©åº¦å¸¯ã€ã§åŠ‡çš„ã«å¤‰ã‚ã‚‹ã‚ˆã†ã«ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¸¯åŸŸï¼ˆplate/column/dendriteï¼‰ã§åˆ‡æ›¿
  - ã•ã‚‰ã«ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ã€ã§æˆé•·é€”ä¸­ã«æ¸©åº¦/æ¹¿åº¦ã‚’å¤‰æ›´å¯èƒ½ï¼ˆæ‰‡å…­èŠ±ãªã©ï¼‰
=========== */

const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');

const ui = {
  btnStart: document.getElementById('btnStart'),
  btnStep: document.getElementById('btnStep'),
  btnReset: document.getElementById('btnReset'),
  btnSnap: document.getElementById('btnSnap'),

  temp: document.getElementById('temp'),
  sup: document.getElementById('sup'),
  tempLabel: document.getElementById('tempLabel'),
  supLabel: document.getElementById('supLabel'),
  modeLabel: document.getElementById('modeLabel'),

  symLock: document.getElementById('symLock'),
  showVapor: document.getElementById('showVapor'),

  steps: document.getElementById('steps'),
  iceCount: document.getElementById('iceCount'),
  params: document.getElementById('params'),

  useProgram: document.getElementById('useProgram'),
  btnAddStage: document.getElementById('btnAddStage'),
  btnClearStages: document.getElementById('btnClearStages'),
  btnFan: document.getElementById('btnFan'),
  btnNakayaTour: document.getElementById('btnNakayaTour'),

  stageBody: document.getElementById('stageBody')
};

const W = cv.width, H = cv.height;

let R = 120;
let running = false;
let rafId = null;

const DIRS = [
  [ 1, 0], [ 1,-1], [ 0,-1],
  [-1, 0], [-1, 1], [ 0, 1]
];

function rot60(q,r){
  const x=q, z=r, y=-x-z;
  const x2 = -z, y2 = -x, z2 = -y;
  return [x2, z2];
}
function rotN(q,r,n){
  let a=q,b=r;
  for(let i=0;i<n;i++){ [a,b]=rot60(a,b); }
  return [a,b];
}
function inHex(q,r){
  const x=q, z=r, y=-x-z;
  return Math.max(Math.abs(x),Math.abs(y),Math.abs(z)) <= R;
}
const key = (q,r)=> `${q},${r}`;

let ice = new Map();
let vapor = new Map();
let stepCount = 0;
let iceCount = 0;

function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }
function lerp(a,b,t){ return a+(b-a)*t; }

// ============ ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸åˆ—ï¼‰ ============
// stage: {steps, tC, sup, label}
let stages = [
  {steps: 500, tC:-15, sup:90, label:"æ¨¹æçŠ¶ï¼ˆæã‚’å‡ºã™ï¼‰"},
  {steps: 350, tC:-10, sup:55, label:"æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼ˆå¤ªã‚‰ã›ã‚‹ï¼‰"},
  {steps: 420, tC:-15, sup:85, label:"å†ã³æ¨¹æçŠ¶ï¼ˆæ‰‡ã£ã½ãï¼‰"},
];

function totalProgramSteps(){
  return stages.reduce((a,s)=>a+Math.max(0,Number(s.steps||0)),0);
}

// ç¾åœ¨ã®stepCountã‹ã‚‰æœ‰åŠ¹ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¿”ã™ï¼ˆæœ«å°¾ã¯ç¹°ã‚Šè¿”ã—ï¼‰
function getStageAt(step){
  if(!ui.useProgram.checked || stages.length===0){
    return {tC:Number(ui.temp.value), sup:Number(ui.sup.value), label:"æ‰‹å‹•"};
  }
  const total = totalProgramSteps();
  if(total<=0){
    return {tC:Number(ui.temp.value), sup:Number(ui.sup.value), label:"æ‰‹å‹•"};
  }
  const s = step % total;
  let acc = 0;
  for(const st of stages){
    const len = Math.max(0, Number(st.steps||0));
    if(s < acc + len){
      return {tC:Number(st.tC), sup:Number(st.sup), label:st.label || "â€”"};
    }
    acc += len;
  }
  // å¿µã®ãŸã‚
  const last = stages[stages.length-1];
  return {tC:Number(last.tC), sup:Number(last.sup), label:last.label || "â€”"};
}

// ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
function renderStageTable(){
  ui.stageBody.innerHTML = "";
  stages.forEach((st, idx)=>{
    const tr = document.createElement("tr");

    const tdIdx = document.createElement("td");
    tdIdx.textContent = String(idx+1);
    tr.appendChild(tdIdx);

    const tdSteps = document.createElement("td");
    const inSteps = document.createElement("input");
    inSteps.type = "number"; inSteps.min = "0"; inSteps.step="10";
    inSteps.value = String(st.steps);
    inSteps.addEventListener("change", ()=>{ st.steps = Number(inSteps.value)||0; });
    tdSteps.appendChild(inSteps);
    tr.appendChild(tdSteps);

    const tdT = document.createElement("td");
    const inT = document.createElement("input");
    inT.type = "number"; inT.min = "-35"; inT.max = "-2"; inT.step="1";
    inT.value = String(st.tC);
    inT.addEventListener("change", ()=>{ st.tC = Number(inT.value)||-15; });
    tdT.appendChild(inT);
    tr.appendChild(tdT);

    const tdSup = document.createElement("td");
    const inSup = document.createElement("input");
    inSup.type = "number"; inSup.min = "0"; inSup.max = "100"; inSup.step="1";
    inSup.value = String(st.sup);
    inSup.addEventListener("change", ()=>{ st.sup = clamp(Number(inSup.value)||70,0,100); inSup.value = String(st.sup); });
    tdSup.appendChild(inSup);
    tr.appendChild(tdSup);

    const tdLab = document.createElement("td");
    const inLab = document.createElement("input");
    inLab.type = "text";
    inLab.value = st.label || "";
    inLab.style.width = "160px";
    inLab.addEventListener("change", ()=>{ st.label = inLab.value; });
    tdLab.appendChild(inLab);
    tr.appendChild(tdLab);

    const tdDel = document.createElement("td");
    const btn = document.createElement("button");
    btn.className = "btn ghost small";
    btn.textContent = "å‰Šé™¤";
    btn.addEventListener("click", ()=>{
      stages.splice(idx,1);
      renderStageTable();
    });
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);

    ui.stageBody.appendChild(tr);
  });
}

// ============ å½¢ã®ã€Œæ¸©åº¦å¸¯ã€åˆ¤å®šï¼ˆä¸­è°·ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ é¢¨ãƒ»ç°¡ç•¥ï¼‰ ============
// å®Ÿéš›ã®ä¸­è°·ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ã‚’å³å¯†å†ç¾ã§ã¯ãªãã€æ•™è‚²ç”¨ã«ã€Œå¸¯ã€ã‚’å¼·èª¿ã—ã¦åŠ‡çš„ã«å¤‰ãˆã‚‹
function bandFromTemp(tC){
  // å¤§é›‘æŠŠã«ï¼š
// -2ï½-8: æŸ±/é‡ï¼ˆcolumnï¼‰å¯„ã‚Šï¼ˆç‰¹ã« -5 ä»˜è¿‘ï¼‰
// -8ï½-13: æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼ˆplateï¼‰å¯„ã‚Šï¼ˆ-10ä»˜è¿‘ï¼‰
// -13ï½-18: æ¨¹æçŠ¶ï¼ˆdendriteï¼‰å¯„ã‚Šï¼ˆ-15ä»˜è¿‘ï¼‰
// -18ï½-26: æŸ±/é‡ï¼ˆcolumnï¼‰å¯„ã‚Šï¼ˆ-20ä»˜è¿‘ï¼‰
// -26ä»¥ä¸‹: æ¿ï¼ˆplateï¼‰å¯„ã‚Šï¼ˆ-30ä»˜è¿‘ï¼‰
  if(tC >= -8) return "column";      // -2..-8
  if(tC >= -13) return "plate";      // -8..-13
  if(tC >= -18) return "dendrite";   // -13..-18
  if(tC >= -26) return "column";     // -18..-26
  return "plate";                    // -26..-35
}

// éé£½å’Œåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -> ä¾›çµ¦é‡
function supplyFromSup(s){
  // 0..100 -> 0.08..3.00
  return 0.08 + 2.92*(s/100);
}

/*
  å¸¯åŸŸã”ã¨ã«ã€Œå½¢ãŒå¤‰ã‚ã‚‹ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¼·ã‚ã«åˆ‡æ›¿
  P = {anis, surf, stick, airDiff, noise, tipExp, consume}
*/
function paramsFrom(tC, sup){
  const sup01 = clamp(sup/100,0,1);
  const band = bandFromTemp(tC);

  // æ¸©åº¦ã«ã‚ˆã‚‹ã€Œå‹•ã‘ãªã•ã€ï¼šä½æ¸©ã»ã©1
  const cold = clamp(((-2) - tC) / 33, 0, 1);

  // å¸¯åŸŸã®åŸºæº–ï¼ˆå¤§èƒ†ã«å¤‰ãˆã‚‹ï¼‰
  let anis, surf, stick, airDiff, noise, tipExp, consume;

  if(band === "dendrite"){
    // æ¨¹æçŠ¶ï¼šå…ˆç«¯ãŒèµ°ã‚‹ / è¡¨é¢æ‹¡æ•£ã¯æŠ‘ãˆã‚‹ / ãƒã‚¤ã‚ºã¯ãã“ãã“
    anis   = 0.78;
    surf   = 0.07;
    stick  = 0.35 + 0.20*(1-cold);   // å°‘ã—æ§ãˆã‚ï¼ˆå¤ªã‚Šã™ãé˜²æ­¢ï¼‰
    airDiff= 0.08 + 0.08*(1-cold);   // ææ–™ã¯å±€åœ¨æ°—å‘³
    noise  = 0.06 + 0.06*sup01;      // æ¹¿åº¦é«˜ã„ã»ã©åˆ†å²
    tipExp = 1.25;                   // å…ˆç«¯å¼·èª¿
    consume= 0.06;                   // æ¶ˆè²»å¼·ã‚ï¼ç´°æå¯„ã‚Š
  } else if(band === "plate"){
    // æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼šé¢ãŒå¤ªã‚‹ / è¡¨é¢æ‹¡æ•£ã‚„ã‚„å¼·ã‚ / ãƒã‚¤ã‚ºå°‘ãªã‚
    anis   = 0.30;
    surf   = 0.22;
    stick  = 0.50;
    airDiff= 0.16;                   // ææ–™ãŒå‡ã•ã‚Œå¤ªã‚Šã‚„ã™ã„
    noise  = 0.02 + 0.02*sup01;
    tipExp = 0.90;                   // å…ˆç«¯å¼·èª¿ã—ãªã„
    consume= 0.11;                   // æ®‹ã—å¤šã‚ï¼é¢ãŒè‚²ã¤
  } else { // column
    // æŸ±/é‡ï¼šå…ˆç«¯æ–¹å‘ã«ä¼¸ã³ã‚‹ãŒã€æåˆ†ã‹ã‚Œã—ã«ãã„ã‚¤ãƒ¡ãƒ¼ã‚¸
    anis   = 0.52;
    surf   = 0.10;
    stick  = 0.58;
    airDiff= 0.10;
    noise  = 0.03 + 0.03*sup01;
    tipExp = 1.10;
    consume= 0.08;
  }

  // æ¸©åº¦ã®è£œæ­£ï¼ˆæ¥µä½æ¸©ã¯è’ã‚Œã‚„ã™ã„ã€æ‹¡æ•£å¼±ã‚ã€ä»˜ç€å¼·ã‚ï¼‰
  stick   = clamp(stick + 0.18*cold, 0.15, 0.85);
  airDiff = clamp(airDiff * (1 - 0.55*cold), 0.04, 0.22);
  noise   = clamp(noise + 0.05*cold, 0.01, 0.18);

  // æ¹¿åº¦è£œæ­£ï¼ˆæ¹¿åº¦ãŒé«˜ã„ã»ã©æåˆ†å²ãƒ»æˆé•·ã¯é€Ÿã„ï¼‰
  anis = clamp(anis + 0.12*(sup01-0.5), 0.15, 0.95);

  return {band, anis, surf, stick, airDiff, noise, tipExp, consume};
}

// ============ çŠ¶æ…‹æ“ä½œ ============
function getV(q,r){ return vapor.get(key(q,r)) ?? 0; }
function setV(q,r,val){ vapor.set(key(q,r), val); }
function isIce(q,r){ return ice.has(key(q,r)); }

function setIce(q,r,forceNoSym=false){
  const k = key(q,r);
  if(!ice.has(k)){
    ice.set(k,1);
    iceCount++;
  }
  if(ui.symLock.checked && !forceNoSym){
    for(let n=1;n<6;n++){
      const [qq,rr]=rotN(q,r,n);
      if(!inHex(qq,rr)) continue;
      const kk=key(qq,rr);
      if(!ice.has(kk)){
        ice.set(kk,1);
        iceCount++;
      }
    }
  }
}

function neighbors(q,r){
  const out=[];
  for(const [dq,dr] of DIRS) out.push([q+dq, r+dr]);
  return out;
}

function collectBoundary(){
  const cand = new Map();
  for(const k of ice.keys()){
    const [q,r]=k.split(',').map(Number);
    for(const [nq,nr] of neighbors(q,r)){
      if(!inHex(nq,nr)) continue;
      if(isIce(nq,nr)) continue;
      const nk=key(nq,nr);
      const cur = cand.get(nk);
      if(cur) cur.nIceNeighbors++;
      else cand.set(nk, {q:nq,r:nr,nIceNeighbors:1});
    }
  }
  return [...cand.values()];
}

function cornerScore(nIceNeighbors){
  if(nIceNeighbors<=1) return 1.0;
  if(nIceNeighbors===2) return 0.65;
  if(nIceNeighbors===3) return 0.30;
  return 0.12;
}

function reset(){
  ice.clear();
  vapor.clear();
  stepCount = 0;
  iceCount = 0;

  for(let q=-R;q<=R;q++){
    for(let r=-R;r<=R;r++){
      if(!inHex(q,r)) continue;
      vapor.set(key(q,r), 1.0);
    }
  }
  setIce(0,0,true);
  draw();
  updateUI();
}

// ============ 1ã‚¹ãƒ†ãƒƒãƒ— ============
function step(){
  // ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰æ¡ä»¶ã‚’æ±ºå®š
  const st = getStageAt(stepCount);
  const tC = st.tC;
  const sup = st.sup;

  // æ‰‹å‹•ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã«ã‚‚åæ˜ ï¼ˆè¦‹ãˆã‚‹åŒ–ï¼‰
  if(ui.useProgram.checked){
    ui.temp.value = String(tC);
    ui.sup.value = String(sup);
  }

  const P = paramsFrom(tC, sup);
  const supply = supplyFromSup(sup);

  // (A) æ°—ç›¸æ‹¡æ•£
  const newV = new Map(vapor);
  for(let q=-R;q<=R;q++){
    for(let r=-R;r<=R;r++){
      if(!inHex(q,r)) continue;
      const k = key(q,r);
      if(isIce(q,r)) { newV.set(k, 0); continue; }
      let sum = getV(q,r), cnt = 1;
      for(const [nq,nr] of neighbors(q,r)){
        if(!inHex(nq,nr)) continue;
        if(isIce(nq,nr)) continue;
        sum += getV(nq,nr);
        cnt++;
      }
      const avg = sum/cnt;
      const v = getV(q,r);
      newV.set(k, v + P.airDiff*(avg - v));
    }
  }
  vapor = newV;

  // (B) ä¾›çµ¦ï¼ˆç«¯ã‹ã‚‰å…¥ã‚Šã‚„ã™ã„ï¼‰
  for(let q=-R;q<=R;q++){
    for(let r=-R;r<=R;r++){
      if(!inHex(q,r)) continue;
      if(isIce(q,r)) continue;
      const x=q, z=r, y=-x-z;
      const dist = Math.max(Math.abs(x),Math.abs(y),Math.abs(z)) / R;
      const add = supply * (0.10 + 0.28*dist);
      setV(q,r, getV(q,r) + add);
    }
  }

  const boundary = collectBoundary();

  // (C) è¡¨é¢æ‹¡æ•£ï¼ˆé¢â†’è§’ã¸å°‘ã—å¯„ã›ã‚‹ï¼‰
  if(boundary.length>0 && P.surf>0){
    const bset = new Set(boundary.map(o=>key(o.q,o.r)));
    const delta = new Map();
    for(const b of boundary){
      const v = getV(b.q,b.r);
      if(v<=0) continue;

      let best = null, bestScore = -1;
      for(const [nq,nr] of neighbors(b.q,b.r)){
        const nk = key(nq,nr);
        if(!bset.has(nk)) continue;
        let ni=0;
        for(const [aq,ar] of neighbors(nq,nr)){
          if(isIce(aq,ar)) ni++;
        }
        const s = cornerScore(ni);
        if(s>bestScore){ bestScore=s; best={q:nq,r:nr}; }
      }
      if(!best) continue;

      const move = v * P.surf * 0.22;
      if(move<=0) continue;

      const k1 = key(b.q,b.r), k2 = key(best.q,best.r);
      delta.set(k1, (delta.get(k1)||0) - move);
      delta.set(k2, (delta.get(k2)||0) + move);
    }
    for(const [k,d] of delta){
      const [q,r]=k.split(',').map(Number);
      setV(q,r, Math.max(0, getV(q,r) + d));
    }
  }

  // (D) æˆé•·ï¼ˆä»˜ç€ï¼‰
  const growList = [];
  const sup01 = clamp(sup/100,0,1);

  for(const b of boundary){
    const v = getV(b.q,b.r);
    if(v<=0) continue;

    const cs = cornerScore(b.nIceNeighbors);

    // å…ˆç«¯åŠ é€Ÿï¼ˆå¸¯åŸŸã«ã‚ˆã£ã¦ tipExp ã‚’å¤‰ãˆã‚‹ï¼åŠ‡çš„ã«å¤‰åŒ–ï¼‰
    const tipBoost = 1.0 + (6.0 * P.anis) * Math.pow(cs, P.tipExp);

    // æ¹¿åº¦ãŒé«˜ã„ã»ã©åˆ†å²ã—ã‚„ã™ãï¼ˆç‰¹ã«æ¨¹æçŠ¶å¸¯ï¼‰
    const ssBoost = 0.70 + 1.35*sup01;

    // åŸºæœ¬ï¼švãŒå¤šã„ã»ã©ä¸ŠãŒã‚‹
    let base = (1 - Math.exp(-v*0.05)) * P.stick;

    // é¢ã‚’å¤ªã‚‰ã›ãŸã„å¸¯ï¼ˆplateï¼‰ã§ã¯ cs ä¾å­˜ã‚’å¼±ã‚ã€æ¨¹æçŠ¶ã§ã¯ cs ä¾å­˜ã‚’å¼·ã‚ã‚‹
    if(P.band === "plate"){
      base *= (0.85 + 0.15*cs);
    }else{
      base *= (0.50 + 0.50*cs);
    }

    let p = base * tipBoost * ssBoost;

    // ãƒã‚¤ã‚ºï¼ˆåˆ†å²ã®ã‚¿ãƒï¼‰
    p += (Math.random()-0.5) * P.noise * (0.6 + 0.9*sup01);

    p = clamp(p, 0, 0.98);

    if(Math.random() < p){
      growList.push([b.q,b.r, v]);
    }
  }

  // æ°·åŒ– & æ¶ˆè²»
  for(const [q,r,v] of growList){
    setIce(q,r);
    setV(q,r, Math.max(0, v*P.consume));
  }

  stepCount++;
}

// ============ æç”» ============
function axialToXY(q,r,size){
  const x = size * (Math.sqrt(3)*q + Math.sqrt(3)/2*r);
  const y = size * (3/2*r);
  return [x,y];
}
function drawHex(x,y,size){
  ctx.beginPath();
  for(let i=0;i<6;i++){
    const a = (Math.PI/180) * (60*i - 30);
    const px = x + size*Math.cos(a);
    const py = y + size*Math.sin(a);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.closePath();
}

function draw(){
  ctx.clearRect(0,0,W,H);
  const size = Math.min(W,H) / (R*2.35);
  const cx = W/2, cy = H/2;

  if(ui.showVapor.checked){
    for(let q=-R;q<=R;q++){
      for(let r=-R;r<=R;r++){
        if(!inHex(q,r)) continue;
        if(isIce(q,r)) continue;
        const v = getV(q,r);
        const t = clamp(v/28, 0, 1);
        if(t<=0) continue;
        const [x,y]=axialToXY(q,r,size);
        ctx.fillStyle = `rgba(125, 211, 252, ${0.16*t})`;
        drawHex(cx+x, cy+y, size*0.98);
        ctx.fill();
      }
    }
  }

  ctx.fillStyle = "rgba(240, 248, 255, 0.98)";
  for(const k of ice.keys()){
    const [q,r]=k.split(',').map(Number);
    const [x,y]=axialToXY(q,r,size);
    drawHex(cx+x, cy+y, size*0.98);
    ctx.fill();
  }

  ctx.strokeStyle = "rgba(125, 211, 252, 0.22)";
  ctx.lineWidth = 1;
  for(const k of ice.keys()){
    const [q,r]=k.split(',').map(Number);
    const [x,y]=axialToXY(q,r,size);
    drawHex(cx+x, cy+y, size*0.98);
    ctx.stroke();
  }
}

function updateUI(){
  const tC = Number(ui.temp.value);
  const sup = Number(ui.sup.value);

  ui.tempLabel.textContent = `${tC}â„ƒ`;
  ui.steps.textContent = String(stepCount);
  ui.iceCount.textContent = String(iceCount);

  ui.supLabel.textContent =
    sup<33 ? "ä½" :
    sup<67 ? "ä¸­" : "é«˜";

  const st = getStageAt(stepCount);
  const P = paramsFrom(st.tC, st.sup);

  ui.modeLabel.textContent =
    (P.band==="dendrite") ? "æ¨¹æçŠ¶" :
    (P.band==="plate") ? "æ¿/ã‚»ã‚¯ã‚¿ãƒ¼" : "æŸ±/é‡";

  ui.params.textContent =
    `band=${P.band} anis=${P.anis.toFixed(2)} surf=${P.surf.toFixed(2)} stick=${P.stick.toFixed(2)} airDiff=${P.airDiff.toFixed(2)} noise=${P.noise.toFixed(2)} tipExp=${P.tipExp.toFixed(2)} cons=${P.consume.toFixed(2)}`;
}

function loop(){
  if(!running) return;
  for(let i=0;i<3;i++) step();
  draw();
  updateUI();
  rafId = requestAnimationFrame(loop);
}

// ============ UIã‚¤ãƒ™ãƒ³ãƒˆ ============
ui.btnStart.addEventListener('click', ()=>{
  running = !running;
  ui.btnStart.textContent = running ? "â¸ åœæ­¢" : "â–¶ é–‹å§‹";
  if(running) loop();
  else if(rafId) cancelAnimationFrame(rafId);
});

ui.btnStep.addEventListener('click', ()=>{
  if(running) return;
  step();
  draw();
  updateUI();
});

ui.btnReset.addEventListener('click', ()=>{
  running = false;
  ui.btnStart.textContent = "â–¶ é–‹å§‹";
  if(rafId) cancelAnimationFrame(rafId);
  reset();
});

ui.temp.addEventListener('input', ()=> updateUI());
ui.sup.addEventListener('input', ()=> updateUI());
ui.showVapor.addEventListener('change', ()=> draw());

ui.btnSnap.addEventListener('click', ()=>{
  const a = document.createElement("a");
  a.download = `snowflake_step${stepCount}.png`;
  a.href = cv.toDataURL("image/png");
  a.click();
});

ui.btnAddStage.addEventListener('click', ()=>{
  stages.push({steps:300, tC:-15, sup:80, label:"è¿½åŠ ã‚¹ãƒ†ãƒ¼ã‚¸"});
  renderStageTable();
});

ui.btnClearStages.addEventListener('click', ()=>{
  stages = [];
  renderStageTable();
});

ui.btnFan.addEventListener('click', ()=>{
  // æ‰‡å…­èŠ±é¢¨ï¼šæã‚’å‡ºã™(-15é«˜) â†’ ã‚»ã‚¯ã‚¿ãƒ¼å¤ªã‚‰ã›ã‚‹(-10ä¸­ä½) â†’ æã‚’è–„ãå‡ºã™(-15ä¸­) â†’ ã‚»ã‚¯ã‚¿ãƒ¼å¤ªã‚‰ã›ã‚‹(-10ä½)
  // ã“ã‚Œã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ã§ã€æ‰‡å½¢ã®å±¤ãŒå‡ºã‚„ã™ã„
  stages = [
    {steps: 420, tC:-15, sup:92, label:"æ¨¹æçŠ¶ï¼šæã‚’å‡ºã™"},
    {steps: 260, tC:-10, sup:52, label:"æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼šå¤ªã‚‰ã›ã‚‹"},
    {steps: 260, tC:-15, sup:78, label:"æ¨¹æçŠ¶ï¼šè–„ãæ"},
    {steps: 220, tC:-10, sup:45, label:"æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼šæ‰‡ã‚’æ•´ãˆã‚‹"},
  ];
  ui.useProgram.checked = true;
  renderStageTable();
  updateUI();
});

ui.btnNakayaTour.addEventListener('click', ()=>{
  // æ¸©åº¦å¸¯ã‚’é †ç•ªã«å·¡ã‚‹ï¼ˆåŠ‡çš„å¤‰åŒ–ã®ä½“é¨“ç”¨ï¼‰
  stages = [
    {steps: 350, tC:-2,  sup:60, label:"å¸¯ï¼šæŸ±/é‡å¯„ã‚Šï¼ˆæš–ã‹ã‚ï¼‰"},
    {steps: 350, tC:-5,  sup:70, label:"å¸¯ï¼šæŸ±/é‡ï¼ˆâˆ’5ä»˜è¿‘ï¼‰"},
    {steps: 350, tC:-10, sup:55, label:"å¸¯ï¼šæ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼ˆâˆ’10ä»˜è¿‘ï¼‰"},
    {steps: 350, tC:-15, sup:90, label:"å¸¯ï¼šæ¨¹æçŠ¶ï¼ˆâˆ’15ä»˜è¿‘ï¼‰"},
    {steps: 350, tC:-20, sup:70, label:"å¸¯ï¼šæŸ±/é‡ï¼ˆâˆ’20ä»˜è¿‘ï¼‰"},
    {steps: 350, tC:-30, sup:60, label:"å¸¯ï¼šæ¿ï¼ˆâˆ’30ä»˜è¿‘ï¼‰"},
  ];
  ui.useProgram.checked = true;
  renderStageTable();
  updateUI();
});

// ä¸­è°·ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆæ‰‹å‹•ç”¨ï¼‰
document.querySelectorAll('[data-nakaya]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const kind = btn.getAttribute('data-nakaya');
    ui.useProgram.checked = false;
    if(kind==="plate"){ ui.temp.value = "-10"; ui.sup.value="55"; }
    if(kind==="column"){ ui.temp.value = "-5";  ui.sup.value="70"; }
    if(kind==="dendrite"){ ui.temp.value = "-15"; ui.sup.value="90"; }
    updateUI();
  });
});

// åˆæœŸåŒ–
renderStageTable();
reset();
updateUI();
</script>
</body>
</html>
