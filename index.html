<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é›ªçµæ™¶ æˆé•·ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆä¸­è°·ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ é¢¨ / æ¡ä»¶åˆ‡æ›¿ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼šæ¨¹æçŠ¶ä¿è¨¼ç‰ˆï¼‰</title>
<style>
  :root{
    --bg:#0b1020; --panel:#111a33cc; --ink:#e9eeff; --muted:#aab4dd;
    --btn:#1e2b59; --btn2:#27387a; --accent:#7dd3fc; --line:#2a3a7a55;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:radial-gradient(1000px 600px at 30% 10%, #182b66 0%, var(--bg) 60%);
    color:var(--ink);
    font-family:system-ui,-apple-system,"M PLUS Rounded 1c",sans-serif;
  }
  header{
    position:sticky;top:0;z-index:5;
    background:linear-gradient(#0b1020ee,#0b102000);
    padding:12px 14px 10px;
    backdrop-filter: blur(6px);
  }
  h1{margin:0;font-size:16px;font-weight:800;letter-spacing:.02em}
  .wrap{display:grid;grid-template-columns: 1fr; gap:10px; padding:10px 12px 16px; max-width:1200px; margin:0 auto;}
  @media (min-width: 980px){ .wrap{grid-template-columns: 1fr 420px;} }
  .card{background:var(--panel); border:1px solid var(--line); border-radius:14px; overflow:hidden;}
  .stage{padding:10px;}
  canvas{width:100%;height:auto;display:block;border-radius:12px;background:#070b16; border:1px solid var(--line);}
  .side{padding:12px 12px 10px; display:flex; flex-direction:column; gap:10px;}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  .btn{
    border:0; padding:10px 12px; border-radius:12px; color:var(--ink);
    background:linear-gradient(180deg,var(--btn2),var(--btn));
    cursor:pointer; font-weight:800; letter-spacing:.02em;
  }
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:#0000;border:1px solid #2a3a7a88}
  .btn.small{padding:7px 10px;font-size:12px;border-radius:10px}
  label{font-size:12px;color:var(--muted)}
  input[type="range"]{width:100%}
  input[type="number"]{width:92px; padding:7px 8px; border-radius:10px; border:1px solid #2a3a7a88; background:#0a1230; color:var(--ink);}
  .kv{display:grid; grid-template-columns: 1fr auto; gap:6px 10px; font-size:12px; color:var(--muted)}
  .kv b{color:var(--ink); font-weight:800}
  .note{font-size:12px;color:var(--muted); line-height:1.5}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0f1a3e;border:1px solid #2a3a7a66;font-size:12px;color:var(--muted)}
  .warn{color:#ffd88a}
  .ok{color:#9ff0c5}
  .table{
    width:100%;
    border-collapse: collapse;
    font-size:12px;
    color:var(--muted);
    overflow:hidden;
    border-radius:12px;
  }
  .table th,.table td{
    border-bottom:1px solid #2a3a7a44;
    padding:8px 6px;
    vertical-align:middle;
  }
  .table th{color:var(--ink); text-align:left; font-weight:800;}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3a7a88;background:#0a1230;color:var(--muted);font-size:11px}
  .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
</style>
</head>
<body>
<header>
  <h1>â„ï¸ é›ªçµæ™¶ æˆé•·ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆä¸­è°·ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ é¢¨ + é€”ä¸­ã§æ¸©åº¦/æ¹¿åº¦ã‚’åˆ‡æ›¿ï¼šæ¨¹æçŠ¶ä¿è¨¼ç‰ˆï¼‰</h1>
</header>

<div class="wrap">
  <div class="card stage">
    <canvas id="cv" width="900" height="900" aria-label="snowflake canvas"></canvas>
  </div>

  <div class="card side">
    <div class="row">
      <button id="btnStart" class="btn">â–¶ é–‹å§‹</button>
      <button id="btnStep" class="btn ghost">ï¼‹1ã‚¹ãƒ†ãƒƒãƒ—</button>
      <button id="btnReset" class="btn ghost">â†º ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="btnSnap" class="btn ghost">ğŸ“· PNGä¿å­˜</button>
    </div>

    <div class="row">
      <span class="pill">ç¾åœ¨ã®æ¡ä»¶</span>
      <span class="tag">æ¸©åº¦ <b id="tempLabel">âˆ’15â„ƒ</b></span>
      <span class="tag">æ¹¿åº¦ <b id="supLabel">é«˜</b></span>
      <span class="tag">ãƒ¢ãƒ¼ãƒ‰ <b id="modeLabel">æ¨¹æçŠ¶</b></span>
    </div>

    <div>
      <label>æ¸©åº¦ï¼ˆæ‰‹å‹•ï¼‰</label>
      <input id="temp" type="range" min="-35" max="-2" step="1" value="-15">
    </div>

    <div>
      <label>æ¹¿åº¦/éé£½å’Œåº¦ï¼ˆæ‰‹å‹•ï¼‰</label>
      <input id="sup" type="range" min="0" max="100" step="1" value="92">
    </div>

    <div class="row">
      <label style="display:flex;gap:8px;align-items:center">
        <input id="symLock" type="checkbox">
        6å›å¯¾ç§°ãƒ­ãƒƒã‚¯ï¼ˆONã«ã™ã‚‹ã¨å…­è§’å½¢ã«å¯„ã‚ŠãŒã¡ï¼‰
      </label>
      <label style="display:flex;gap:8px;align-items:center">
        <input id="showVapor" type="checkbox">
        æ°´è’¸æ°—ï¼ˆèƒŒæ™¯ï¼‰ã‚’è¡¨ç¤º
      </label>
    </div>

    <div class="kv">
      <div>ã‚¹ãƒ†ãƒƒãƒ—</div><b id="steps">0</b>
      <div>æ°·ã‚»ãƒ«æ•°</div><b id="iceCount">0</b>
      <div>å†…éƒ¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</div><b id="params" class="mono">â€”</b>
    </div>

    <div class="row">
      <span class="pill">ä¸­è°·ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ é¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆ</span>
      <button class="btn ghost small" data-nakaya="plate">æ¿çŠ¶ï¼ˆâˆ’10å¸¯ï¼‰</button>
      <button class="btn ghost small" data-nakaya="column">æŸ±çŠ¶ï¼ˆâˆ’5/âˆ’20å¸¯ï¼‰</button>
      <button class="btn ghost small" data-nakaya="dendrite">æ¨¹æçŠ¶ï¼ˆâˆ’15å¸¯ï¼‰</button>
    </div>

    <div class="row">
      <span class="pill">æ¡ä»¶åˆ‡æ›¿ãƒ—ãƒ­ã‚°ãƒ©ãƒ </span>
      <label style="display:flex;gap:8px;align-items:center">
        <input id="useProgram" type="checkbox" checked>
        ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½¿ç”¨ï¼ˆONã§é€”ä¸­åˆ‡æ›¿ï¼‰
      </label>
    </div>

    <div class="row">
      <button id="btnAddStage" class="btn ghost small">ï¼‹ã‚¹ãƒ†ãƒ¼ã‚¸è¿½åŠ </button>
      <button id="btnClearStages" class="btn ghost small">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
      <button id="btnFan" class="btn ghost small">ğŸª­ æ‰‡å…­èŠ±ãƒ¢ãƒ¼ãƒ‰</button>
      <button id="btnNakayaTour" class="btn ghost small">ğŸ—º æ¸©åº¦å¸¯ãƒ„ã‚¢ãƒ¼</button>
    </div>

    <div class="note">
      <b class="ok">ã“ã®ç‰ˆã®é•ã„ï¼š</b><br>
      ãƒ»æ°´è’¸æ°—ã¯ <span class="warn">å¤–å‘¨ãƒªãƒ³ã‚°ã‹ã‚‰ã®ã¿ä¾›çµ¦</span>ï¼ˆæ‹¡æ•£å¾‹é€Ÿï¼‰<br>
      ãƒ»1ã‚¹ãƒ†ãƒƒãƒ—ã§æ°·åŒ–ã™ã‚‹æ•°ã‚’ <span class="warn">ä¸Šé™(maxAttach)</span> ã§åˆ¶é™<br>
      ãƒ»ä»˜ç€ã¯ã€Œå…ˆç«¯ï¼‹æ°´è’¸æ°—ãŒå¤šã„ã‚»ãƒ«ã€ã‚’ <span class="warn">é‡ã¿ä»˜ãæŠ½é¸</span>ã§é¸æŠœ<br>
      â†’ ã“ã‚Œã§ <b>æ¨¹æçŠ¶/æ‰‡å…­èŠ±ãŒç¢ºå®Ÿã«å‡ºã¾ã™</b>ã€‚
    </div>

    <div style="border:1px solid #2a3a7a44;border-radius:12px;overflow:hidden">
      <table class="table">
        <thead>
          <tr>
            <th>#</th><th>ç¶™ç¶š(steps)</th><th>æ¸©åº¦</th><th>æ¹¿åº¦</th><th>ç‹™ã„</th><th></th>
          </tr>
        </thead>
        <tbody id="stageBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');

const ui = {
  btnStart: document.getElementById('btnStart'),
  btnStep: document.getElementById('btnStep'),
  btnReset: document.getElementById('btnReset'),
  btnSnap: document.getElementById('btnSnap'),
  temp: document.getElementById('temp'),
  sup: document.getElementById('sup'),
  tempLabel: document.getElementById('tempLabel'),
  supLabel: document.getElementById('supLabel'),
  modeLabel: document.getElementById('modeLabel'),
  symLock: document.getElementById('symLock'),
  showVapor: document.getElementById('showVapor'),
  steps: document.getElementById('steps'),
  iceCount: document.getElementById('iceCount'),
  params: document.getElementById('params'),
  useProgram: document.getElementById('useProgram'),
  btnAddStage: document.getElementById('btnAddStage'),
  btnClearStages: document.getElementById('btnClearStages'),
  btnFan: document.getElementById('btnFan'),
  btnNakayaTour: document.getElementById('btnNakayaTour'),
  stageBody: document.getElementById('stageBody')
};

const W = cv.width, H = cv.height;
let R = 120;
let running = false;
let rafId = null;

const DIRS = [
  [ 1, 0], [ 1,-1], [ 0,-1],
  [-1, 0], [-1, 1], [ 0, 1]
];

function rot60(q,r){
  const x=q, z=r, y=-x-z;
  const x2 = -z, y2 = -x, z2 = -y;
  return [x2, z2];
}
function rotN(q,r,n){
  let a=q,b=r;
  for(let i=0;i<n;i++){ [a,b]=rot60(a,b); }
  return [a,b];
}
function inHex(q,r){
  const x=q, z=r, y=-x-z;
  return Math.max(Math.abs(x),Math.abs(y),Math.abs(z)) <= R;
}
const key = (q,r)=> `${q},${r}`;
function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }

let ice = new Map();
let vapor = new Map();
let stepCount = 0;
let iceCount = 0;

// ====== ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆæ‰‡å…­èŠ±/æ¨¹æçŠ¶ãŒç¢ºå®Ÿã«å‡ºã‚‹åˆæœŸã‚»ãƒƒãƒˆï¼‰ ======
let stages = [
  {steps: 520, tC:-15, sup:96, label:"æ¨¹æçŠ¶ï¼šæã‚’å‡ºã™ï¼ˆç¢ºå®Ÿï¼‰"},
  {steps: 260, tC:-10, sup:52, label:"æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼šå¤ªã‚‰ã›ã‚‹"},
  {steps: 420, tC:-15, sup:86, label:"æ¨¹æçŠ¶ï¼šå†åˆ†å²"},
  {steps: 220, tC:-10, sup:45, label:"æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼šæ‰‡ã‚’æ•´ãˆã‚‹"},
];

function totalProgramSteps(){
  return stages.reduce((a,s)=>a+Math.max(0,Number(s.steps||0)),0);
}
function getStageAt(step){
  if(!ui.useProgram.checked || stages.length===0){
    return {tC:Number(ui.temp.value), sup:Number(ui.sup.value), label:"æ‰‹å‹•"};
  }
  const total = totalProgramSteps();
  if(total<=0) return {tC:Number(ui.temp.value), sup:Number(ui.sup.value), label:"æ‰‹å‹•"};
  const s = step % total;
  let acc = 0;
  for(const st of stages){
    const len = Math.max(0, Number(st.steps||0));
    if(s < acc + len) return {tC:Number(st.tC), sup:Number(st.sup), label:st.label || "â€”"};
    acc += len;
  }
  const last = stages[stages.length-1];
  return {tC:Number(last.tC), sup:Number(last.sup), label:last.label || "â€”"};
}

function renderStageTable(){
  ui.stageBody.innerHTML = "";
  stages.forEach((st, idx)=>{
    const tr = document.createElement("tr");

    const tdIdx = document.createElement("td"); tdIdx.textContent = String(idx+1); tr.appendChild(tdIdx);

    const tdSteps = document.createElement("td");
    const inSteps = document.createElement("input");
    inSteps.type="number"; inSteps.min="0"; inSteps.step="10"; inSteps.value=String(st.steps);
    inSteps.addEventListener("change", ()=> st.steps = Number(inSteps.value)||0);
    tdSteps.appendChild(inSteps); tr.appendChild(tdSteps);

    const tdT = document.createElement("td");
    const inT = document.createElement("input");
    inT.type="number"; inT.min="-35"; inT.max="-2"; inT.step="1"; inT.value=String(st.tC);
    inT.addEventListener("change", ()=> st.tC = Number(inT.value)||-15);
    tdT.appendChild(inT); tr.appendChild(tdT);

    const tdSup = document.createElement("td");
    const inSup = document.createElement("input");
    inSup.type="number"; inSup.min="0"; inSup.max="100"; inSup.step="1"; inSup.value=String(st.sup);
    inSup.addEventListener("change", ()=>{ st.sup = clamp(Number(inSup.value)||70,0,100); inSup.value=String(st.sup); });
    tdSup.appendChild(inSup); tr.appendChild(tdSup);

    const tdLab = document.createElement("td");
    const inLab = document.createElement("input");
    inLab.type="text"; inLab.value=st.label||""; inLab.style.width="160px";
    inLab.addEventListener("change", ()=> st.label = inLab.value);
    tdLab.appendChild(inLab); tr.appendChild(tdLab);

    const tdDel = document.createElement("td");
    const btn = document.createElement("button");
    btn.className="btn ghost small"; btn.textContent="å‰Šé™¤";
    btn.addEventListener("click", ()=>{ stages.splice(idx,1); renderStageTable(); });
    tdDel.appendChild(btn); tr.appendChild(tdDel);

    ui.stageBody.appendChild(tr);
  });
}

// ====== ä¸­è°·å¸¯ï¼ˆç°¡ç•¥ï¼‰ ======
function bandFromTemp(tC){
  if(tC >= -8) return "column";      // -2..-8
  if(tC >= -13) return "plate";      // -8..-13
  if(tC >= -18) return "dendrite";   // -13..-18
  if(tC >= -26) return "column";     // -18..-26
  return "plate";                    // -26..-35
}

// ====== ã“ã®ç‰ˆã®è‚ï¼šå¤–å‘¨ä¾›çµ¦ï¼†ä»˜ç€æ•°åˆ¶é™ ======
// å¤–å‘¨ãƒªãƒ³ã‚°å¹…ï¼ˆdist>EDGE_START ã‚’ãƒªã‚¶ãƒ¼ãƒæ‰±ã„ï¼‰
const EDGE_START = 0.90;

// ä¾›çµ¦ï¼šsup(0..100) -> å¤–å‘¨ãƒªã‚¶ãƒ¼ãƒæ°´è’¸æ°—é‡
function edgeReservoirFromSup(sup){
  // æ¨¹æçŠ¶ã‚’å‡ºã™ãŸã‚ã€ä¸Šé™ã‚’å¤§ãã
  // 0..100 -> 16..70
  return 16 + 54*(sup/100);
}

// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå¸¯åŸŸã”ã¨ï¼‹ç¢ºå®Ÿã«å½¢ãŒå‡ºã‚‹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼‰
function paramsFrom(tC, sup){
  const sup01 = clamp(sup/100,0,1);
  const band = bandFromTemp(tC);
  const cold = clamp(((-2) - tC)/33, 0, 1);

  // å…±é€šï¼šå¤–å‘¨ãƒªã‚¶ãƒ¼ãƒ
  const edgeV = edgeReservoirFromSup(sup);

  let anis, surf, stick, airDiff, noise, vPow, csPow, maxAttach, consume;

  if(band==="dendrite"){
    // â˜…ç¢ºå®Ÿã«æ¨¹æçŠ¶ï¼šå…ˆç«¯å¼·å„ªé‡ï¼†1stepä»˜ç€æ•°ã‚’çµã‚‹
    anis = 0.92;
    surf = 0.06;
    stick = 0.18;             // é¢ãŒå¤ªã‚Šã«ãã„
    airDiff = 0.11;           // æ‹¡æ•£ã¯æ®‹ã™ï¼ˆå½±ãŒã§ãã‚‹ï¼‰
    noise = 0.10 + 0.06*sup01;
    vPow = 1.25;              // vaporãŒå¤šã„æ‰€ã‚’å¼·ãé¸ã¶
    csPow = 3.0;              // å…ˆç«¯ã‚’å¼·çƒˆã«é¸ã¶ï¼ˆé‡è¦ï¼‰
    maxAttach = Math.round(2 + 6*sup01); // 1ã‚¹ãƒ†ãƒƒãƒ—ã®æ°·åŒ–ä¸Šé™ï¼ˆå°ã•ãï¼‰
    consume = 0.02;           // æ°·åŒ–å¾Œã«vaporã‚’ã‹ãªã‚Šæ®‹ã™ï¼ˆå…ˆç«¯ãŒé¤“ãˆã«ãã„ï¼‰
  } else if(band==="plate"){
    // æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼šé¢ãŒå¤ªã‚‹ï¼ˆä»˜ç€æ•°å¤šã‚ï¼†å¹³æ»‘åŒ–ï¼‰
    anis = 0.22;
    surf = 0.24;
    stick = 0.40;
    airDiff = 0.17;
    noise = 0.02 + 0.02*sup01;
    vPow = 0.85;
    csPow = 1.0;
    maxAttach = Math.round(10 + 20*sup01); // é¢ã‚’è‚²ã¦ã‚‹ã®ã§å¤šã‚
    consume = 0.10;
  } else { // column
    // æŸ±/é‡ï¼šä¸­é–“ï¼ˆæã¯å°‘ãªã‚ï¼‰
    anis = 0.55;
    surf = 0.10;
    stick = 0.30;
    airDiff = 0.12;
    noise = 0.04 + 0.03*sup01;
    vPow = 1.00;
    csPow = 1.6;
    maxAttach = Math.round(4 + 10*sup01);
    consume = 0.06;
  }

  // ä½æ¸©è£œæ­£ï¼ˆè’ã‚Œã‚„ã™ã•ç­‰ï¼‰
  stick = clamp(stick + 0.08*cold, 0.10, 0.75);
  airDiff = clamp(airDiff*(1-0.35*cold), 0.05, 0.22);
  noise = clamp(noise + 0.05*cold, 0.01, 0.20);

  return {band, anis, surf, stick, airDiff, noise, vPow, csPow, maxAttach, consume, edgeV};
}

// ====== çŠ¶æ…‹æ“ä½œ ======
function getV(q,r){ return vapor.get(key(q,r)) ?? 0; }
function setV(q,r,val){ vapor.set(key(q,r), val); }
function isIce(q,r){ return ice.has(key(q,r)); }

function setIce(q,r,forceNoSym=false){
  const k = key(q,r);
  if(!ice.has(k)){
    ice.set(k,1);
    iceCount++;
  }
  if(ui.symLock.checked && !forceNoSym){
    for(let n=1;n<6;n++){
      const [qq,rr]=rotN(q,r,n);
      if(!inHex(qq,rr)) continue;
      const kk=key(qq,rr);
      if(!ice.has(kk)){
        ice.set(kk,1);
        iceCount++;
      }
    }
  }
}

function neighbors(q,r){
  const out=[];
  for(const [dq,dr] of DIRS) out.push([q+dq, r+dr]);
  return out;
}

function collectBoundary(){
  const cand = new Map();
  for(const k of ice.keys()){
    const [q,r]=k.split(',').map(Number);
    for(const [nq,nr] of neighbors(q,r)){
      if(!inHex(nq,nr)) continue;
      if(isIce(nq,nr)) continue;
      const nk=key(nq,nr);
      const cur = cand.get(nk);
      if(cur) cur.nIceNeighbors++;
      else cand.set(nk, {q:nq,r:nr,nIceNeighbors:1});
    }
  }
  return [...cand.values()];
}

function cornerScore(nIceNeighbors){
  if(nIceNeighbors<=1) return 1.0;
  if(nIceNeighbors===2) return 0.65;
  if(nIceNeighbors===3) return 0.30;
  return 0.12;
}

function hexDist01(q,r){
  const x=q, z=r, y=-x-z;
  return Math.max(Math.abs(x),Math.abs(y),Math.abs(z)) / R; // 0..1
}

function reset(){
  ice.clear();
  vapor.clear();
  stepCount = 0;
  iceCount = 0;

  // â˜…åˆæœŸã¯ã€Œå¤–å‘¨ã«ã ã‘æ°´è’¸æ°—ã€ï¼šæœ€åˆã‹ã‚‰æ‹¡æ•£å¾‹é€Ÿã«ã™ã‚‹
  for(let q=-R;q<=R;q++){
    for(let r=-R;r<=R;r++){
      if(!inHex(q,r)) continue;
      const d = hexDist01(q,r);
      vapor.set(key(q,r), d>EDGE_START ? 30.0 : 0.2);
    }
  }

  setIce(0,0,true);
  draw();
  updateUI();
}

// ====== ä»˜ç€ã‚»ãƒ«ã®ã€Œé‡ã¿ä»˜ãæŠ½é¸ã€ ======
function weightedSample(items, weights, k){
  const out = [];
  const poolItems = items.slice();
  const poolW = weights.slice();

  for(let t=0; t<k && poolItems.length>0; t++){
    let sum = 0;
    for(const w of poolW) sum += w;
    if(sum <= 0) break;

    let r = Math.random()*sum;
    let idx = 0;
    for(; idx<poolW.length; idx++){
      r -= poolW[idx];
      if(r<=0) break;
    }
    if(idx>=poolItems.length) idx = poolItems.length-1;

    out.push(poolItems[idx]);
    poolItems.splice(idx,1);
    poolW.splice(idx,1);
  }
  return out;
}

// ====== 1ã‚¹ãƒ†ãƒƒãƒ— ======
function step(){
  const st = getStageAt(stepCount);
  const tC = st.tC;
  const sup = st.sup;

  if(ui.useProgram.checked){
    ui.temp.value = String(tC);
    ui.sup.value = String(sup);
  }

  const P = paramsFrom(tC, sup);

  // (0) å¤–å‘¨ãƒªã‚¶ãƒ¼ãƒï¼šdist>EDGE_START ã®ã‚»ãƒ«ã¯ v >= edgeV ã‚’ä¿è¨¼ï¼ˆã“ã“ãŒé‡è¦ï¼‰
  for(let q=-R;q<=R;q++){
    for(let r=-R;r<=R;r++){
      if(!inHex(q,r)) continue;
      if(isIce(q,r)) { setV(q,r,0); continue; }
      const d = hexDist01(q,r);
      if(d > EDGE_START){
        setV(q,r, Math.max(getV(q,r), P.edgeV));
      }
    }
  }

  // (A) æ°—ç›¸æ‹¡æ•£ï¼ˆvaporå¹³æ»‘åŒ–ï¼šæ°·ã‚’é¿ã‘ã¦æ‹¡æ•£ï¼‰
  const newV = new Map(vapor);
  for(let q=-R;q<=R;q++){
    for(let r=-R;r<=R;r++){
      if(!inHex(q,r)) continue;
      const k = key(q,r);
      if(isIce(q,r)) { newV.set(k, 0); continue; }
      let sum = getV(q,r), cnt = 1;
      for(const [nq,nr] of neighbors(q,r)){
        if(!inHex(nq,nr)) continue;
        if(isIce(nq,nr)) continue;
        sum += getV(nq,nr);
        cnt++;
      }
      const avg = sum/cnt;
      const v = getV(q,r);
      newV.set(k, v + P.airDiff*(avg - v));
    }
  }
  vapor = newV;

  const boundary = collectBoundary();
  if(boundary.length===0){
    stepCount++;
    return;
  }

  // (B) è¡¨é¢æ‹¡æ•£ï¼ˆå¢ƒç•Œã§ã€å°‘ã—å…ˆç«¯å¯„ã‚Šã«ææ–™ç§»å‹•ï¼‰
  if(P.surf>0){
    const bset = new Set(boundary.map(o=>key(o.q,o.r)));
    const delta = new Map();
    for(const b of boundary){
      const v = getV(b.q,b.r);
      if(v<=0) continue;

      let best = null, bestScore = -1;
      for(const [nq,nr] of neighbors(b.q,b.r)){
        const nk = key(nq,nr);
        if(!bset.has(nk)) continue;
        let ni=0;
        for(const [aq,ar] of neighbors(nq,nr)){
          if(isIce(aq,ar)) ni++;
        }
        const s = cornerScore(ni);
        if(s>bestScore){ bestScore=s; best={q:nq,r:nr}; }
      }
      if(!best) continue;

      const move = v * P.surf * 0.18;
      if(move<=0) continue;

      const k1=key(b.q,b.r), k2=key(best.q,best.r);
      delta.set(k1,(delta.get(k1)||0)-move);
      delta.set(k2,(delta.get(k2)||0)+move);
    }
    for(const [k,d] of delta){
      const [q,r]=k.split(',').map(Number);
      setV(q,r, Math.max(0, getV(q,r)+d));
    }
  }

  // (C) æˆé•·ï¼ˆä»˜ç€ï¼‰
  // â˜…ã€Œç¢ºå®Ÿã«æ¨¹æçŠ¶ã€ã‚’ä½œã‚‹ãŸã‚ã€å¢ƒç•Œã‚»ãƒ«ã‚’é‡ã¿ä»˜ãæŠ½é¸ã—ã¦ maxAttach å€‹ã ã‘æ°·åŒ–
  const items = [];
  const weights = [];
  for(const b of boundary){
    const v = getV(b.q,b.r);
    if(v<=0) continue;

    const cs = cornerScore(b.nIceNeighbors);
    // å…ˆç«¯å¼·å„ªé‡ï¼šcsPow ãŒåŠ¹ãï¼ˆæ¨¹æçŠ¶å¸¯ã§ã¯ 3.0ï¼‰
    const tip = Math.pow(cs, P.csPow);

    // vaporãŒå¤šã„ã¨ã“ã‚ã‚’å„ªé‡ï¼švPow
    const vv = Math.pow(Math.max(0.0001, v), P.vPow);

    // ä»˜ç€ã®åŸºç¤ï¼ˆstickï¼‰ã¨å°‘é‡ãƒã‚¤ã‚º
    let w = P.stick * vv * (0.15 + 1.85*P.anis*tip);
    w *= (0.90 + 0.30*Math.random()); // å¾®ãƒ©ãƒ³ãƒ€ãƒ 
    w += (Math.random()-0.5) * P.noise;

    if(w>0){
      items.push(b);
      weights.push(w);
    }
  }

  const pickN = Math.max(1, Math.min(P.maxAttach, items.length));
  const chosen = weightedSample(items, weights, pickN);

  for(const b of chosen){
    const v = getV(b.q,b.r);
    setIce(b.q,b.r);
    setV(b.q,b.r, Math.max(0, v*P.consume));
  }

  stepCount++;
}

// ====== æç”» ======
function axialToXY(q,r,size){
  const x = size * (Math.sqrt(3)*q + Math.sqrt(3)/2*r);
  const y = size * (3/2*r);
  return [x,y];
}
function drawHex(x,y,size){
  ctx.beginPath();
  for(let i=0;i<6;i++){
    const a = (Math.PI/180) * (60*i - 30);
    const px = x + size*Math.cos(a);
    const py = y + size*Math.sin(a);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.closePath();
}
function draw(){
  ctx.clearRect(0,0,W,H);
  const size = Math.min(W,H) / (R*2.35);
  const cx = W/2, cy = H/2;

  if(ui.showVapor.checked){
    for(let q=-R;q<=R;q++){
      for(let r=-R;r<=R;r++){
        if(!inHex(q,r)) continue;
        if(isIce(q,r)) continue;
        const v = getV(q,r);
        const t = clamp(v/70, 0, 1);
        if(t<=0) continue;
        const [x,y]=axialToXY(q,r,size);
        ctx.fillStyle = `rgba(125, 211, 252, ${0.18*t})`;
        drawHex(cx+x, cy+y, size*0.98);
        ctx.fill();
      }
    }
  }

  ctx.fillStyle = "rgba(240, 248, 255, 0.98)";
  for(const k of ice.keys()){
    const [q,r]=k.split(',').map(Number);
    const [x,y]=axialToXY(q,r,size);
    drawHex(cx+x, cy+y, size*0.98);
    ctx.fill();
  }

  ctx.strokeStyle = "rgba(125, 211, 252, 0.22)";
  ctx.lineWidth = 1;
  for(const k of ice.keys()){
    const [q,r]=k.split(',').map(Number);
    const [x,y]=axialToXY(q,r,size);
    drawHex(cx+x, cy+y, size*0.98);
    ctx.stroke();
  }
}

function updateUI(){
  const tC = Number(ui.temp.value);
  const sup = Number(ui.sup.value);
  ui.tempLabel.textContent = `${tC}â„ƒ`;
  ui.steps.textContent = String(stepCount);
  ui.iceCount.textContent = String(iceCount);

  ui.supLabel.textContent =
    sup<33 ? "ä½" :
    sup<67 ? "ä¸­" : "é«˜";

  const st = getStageAt(stepCount);
  const P = paramsFrom(st.tC, st.sup);

  ui.modeLabel.textContent =
    (P.band==="dendrite") ? "æ¨¹æçŠ¶" :
    (P.band==="plate") ? "æ¿/ã‚»ã‚¯ã‚¿ãƒ¼" : "æŸ±/é‡";

  ui.params.textContent =
    `band=${P.band} anis=${P.anis.toFixed(2)} surf=${P.surf.toFixed(2)} stick=${P.stick.toFixed(2)} airDiff=${P.airDiff.toFixed(2)} noise=${P.noise.toFixed(2)} vPow=${P.vPow.toFixed(2)} csPow=${P.csPow.toFixed(2)} maxA=${P.maxAttach} cons=${P.consume.toFixed(2)} edgeV=${P.edgeV.toFixed(1)}`;
}

function loop(){
  if(!running) return;
  for(let i=0;i<3;i++) step();
  draw();
  updateUI();
  rafId = requestAnimationFrame(loop);
}

// ====== UI ======
ui.btnStart.addEventListener('click', ()=>{
  running = !running;
  ui.btnStart.textContent = running ? "â¸ åœæ­¢" : "â–¶ é–‹å§‹";
  if(running) loop();
  else if(rafId) cancelAnimationFrame(rafId);
});
ui.btnStep.addEventListener('click', ()=>{
  if(running) return;
  step(); draw(); updateUI();
});
ui.btnReset.addEventListener('click', ()=>{
  running=false;
  ui.btnStart.textContent="â–¶ é–‹å§‹";
  if(rafId) cancelAnimationFrame(rafId);
  reset();
});
ui.btnSnap.addEventListener('click', ()=>{
  const a=document.createElement("a");
  a.download=`snowflake_step${stepCount}.png`;
  a.href=cv.toDataURL("image/png");
  a.click();
});
ui.temp.addEventListener('input', ()=> updateUI());
ui.sup.addEventListener('input', ()=> updateUI());
ui.showVapor.addEventListener('change', ()=> draw());

ui.btnAddStage.addEventListener('click', ()=>{
  stages.push({steps:300, tC:-15, sup:90, label:"è¿½åŠ ã‚¹ãƒ†ãƒ¼ã‚¸"});
  renderStageTable();
});
ui.btnClearStages.addEventListener('click', ()=>{
  stages=[]; renderStageTable();
});

// â˜…æ‰‡å…­èŠ±ï¼šç¢ºå®Ÿã«ã€Œæâ†’ã‚»ã‚¯ã‚¿ãƒ¼â†’æâ†’ã‚»ã‚¯ã‚¿ãƒ¼ã€
ui.btnFan.addEventListener('click', ()=>{
  stages = [
    {steps: 520, tC:-15, sup:96, label:"æ¨¹æçŠ¶ï¼šæã‚’å‡ºã™ï¼ˆç¢ºå®Ÿï¼‰"},
    {steps: 260, tC:-10, sup:52, label:"æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼šå¤ªã‚‰ã›ã‚‹"},
    {steps: 420, tC:-15, sup:86, label:"æ¨¹æçŠ¶ï¼šå†åˆ†å²"},
    {steps: 220, tC:-10, sup:45, label:"æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼šæ‰‡ã‚’æ•´ãˆã‚‹"},
  ];
  ui.useProgram.checked = true;
  renderStageTable();
  updateUI();
});

// æ¸©åº¦å¸¯ãƒ„ã‚¢ãƒ¼ï¼ˆå„å¸¯ãŒâ€œå¿…ãšâ€é•ã£ã¦è¦‹ãˆã‚‹å€¤ï¼‰
ui.btnNakayaTour.addEventListener('click', ()=>{
  stages = [
    {steps: 360, tC:-5,  sup:75, label:"æŸ±/é‡ï¼ˆâˆ’5ï¼‰"},
    {steps: 360, tC:-10, sup:50, label:"æ¿/ã‚»ã‚¯ã‚¿ãƒ¼ï¼ˆâˆ’10ï¼‰"},
    {steps: 520, tC:-15, sup:96, label:"æ¨¹æçŠ¶ï¼ˆâˆ’15ï¼‰"},
    {steps: 360, tC:-20, sup:70, label:"æŸ±/é‡ï¼ˆâˆ’20ï¼‰"},
    {steps: 360, tC:-30, sup:55, label:"æ¿ï¼ˆâˆ’30ï¼‰"},
  ];
  ui.useProgram.checked = true;
  renderStageTable();
  updateUI();
});

// æ‰‹å‹•ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆç¢ºå®Ÿã«å‡ºã‚‹å€¤ã«å›ºå®šï¼‰
document.querySelectorAll('[data-nakaya]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const kind = btn.getAttribute('data-nakaya');
    ui.useProgram.checked = false;
    if(kind==="plate"){ ui.temp.value="-10"; ui.sup.value="50"; }
    if(kind==="column"){ ui.temp.value="-5"; ui.sup.value="75"; }
    if(kind==="dendrite"){ ui.temp.value="-15"; ui.sup.value="96"; }
    updateUI();
  });
});

// åˆæœŸåŒ–
renderStageTable();
reset();
updateUI();
</script>
</body>
</html>
